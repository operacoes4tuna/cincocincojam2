{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
{% if form.instance.pk %}Editar Aula{% else %}Nova Aula{% endif %} - CincoCincoJAM 2.0
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'courses:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'courses:course_list' %}">Cursos</a></li>
                <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' course.id %}">{{ course.title }}</a>
                </li>
                <li class="breadcrumb-item active">
                    {% if form.instance.pk %}Editar Aula{% else %}Nova Aula{% endif %}
                </li>
            </ol>
        </nav>
        <h2>{% if form.instance.pk %}Editar Aula{% else %}Nova Aula{% endif %}</h2>
        <p class="text-muted">
            <i class="fas fa-book me-1"></i> Curso: <strong>{{ course.title }}</strong>
            {% if form.instance.pk %}
            <span class="ms-2">
                <i class="fas fa-clock me-1"></i> Última atualização: {{ form.instance.updated_at|date:"d/m/Y" }}
            </span>
            {% endif %}
        </p>
    </div>
    <div>
        <a href="{% url 'courses:course_detail' course.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para o Curso
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-edit me-2"></i> Informações da Aula</h5>
            </div>
            <div class="card-body">
                <form method="post" id="lesson-form" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="mb-4">
                        {{ form.module|as_crispy_field }}
                        <small class="form-text text-muted">Selecione o módulo ao qual esta aula pertence (opcional).</small>
                    </div>

                    <div class="mb-4">
                        {{ form.title|as_crispy_field }}
                        <small class="form-text text-muted">Um título claro e descritivo do conteúdo da aula.</small>
                    </div>

                    <div class="mb-4">
                        {{ form.description|as_crispy_field }}
                        <small class="form-text text-muted">Descreva detalhadamente o que o aluno aprenderá nesta
                            aula.</small>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="mb-3">
                                {{ form.video_url|as_crispy_field }}
                                <small class="form-text text-muted">Cole a URL do vídeo do YouTube ou do 55JAM (ex:
                                    https://www.youtube.com/watch?v=VIDEO_ID ou https://play.55jam.com.br/embed/XX/HASH)</small>
                                {% if form.instance.video_url %}
                                <div class="mt-2">
                                    <small class="text-muted">URL atual: <a href="{{ form.instance.video_url }}"
                                            target="_blank">{{ form.instance.video_url }}</a></small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Anexos -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-paperclip me-2"></i>Anexos da Aula
                        </label>
                        <p class="text-muted small">Adicione materiais complementares como PDFs, áudios, imagens, documentos ou links úteis.</p>

                        <!-- Lista de anexos existentes (se editando aula) -->
                        {% if form.instance.pk %}
                            {% if form.instance.attachments.exists %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-3"><i class="fas fa-paperclip me-2"></i>Anexos atuais:</h6>
                                <div class="list-group mb-3" id="existing-attachments">
                                    {% for attachment in form.instance.attachments.all %}
                                    <div class="list-group-item attachment-item" data-id="{{ attachment.id }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    {% if attachment.attachment_type == 'PDF' %}
                                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                                    {% elif attachment.attachment_type == 'AUDIO' %}
                                                        <i class="fas fa-file-audio text-info me-2"></i>
                                                    {% elif attachment.attachment_type == 'IMAGE' %}
                                                        <i class="fas fa-file-image text-success me-2"></i>
                                                    {% elif attachment.attachment_type == 'DOCX' %}
                                                        <i class="fas fa-file-word text-primary me-2"></i>
                                                    {% elif attachment.attachment_type == 'LINK' %}
                                                        <i class="fas fa-link text-secondary me-2"></i>
                                                    {% else %}
                                                        <i class="fas fa-file text-muted me-2"></i>
                                                    {% endif %}
                                                    {{ attachment.title }}
                                                </h6>
                                                {% if attachment.description %}
                                                <p class="mb-1 text-muted small">{{ attachment.description }}</p>
                                                {% endif %}
                                                {% if attachment.file %}
                                                <small class="text-muted">Arquivo: {{ attachment.file.name|slice:"20:" }}</small>
                                                {% elif attachment.link %}
                                                <small class="text-muted">Link: <a href="{{ attachment.link }}" target="_blank">{{ attachment.link|truncatechars:50 }}</a></small>
                                                {% endif %}
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                {% if attachment.file %}
                                                <a href="{{ attachment.get_file_url }}" target="_blank" class="btn btn-outline-primary" title="Abrir anexo">
                                                    <i class="fas fa-external-link-alt"></i> Abrir
                                                </a>
                                                {% elif attachment.link %}
                                                <a href="{{ attachment.link }}" target="_blank" class="btn btn-outline-primary" title="Abrir link">
                                                    <i class="fas fa-external-link-alt"></i> Abrir
                                                </a>
                                                {% endif %}
                                                <button type="button" class="btn btn-outline-danger remove-attachment" data-id="{{ attachment.id }}" title="Remover anexo">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}

                        <!-- Container para novos anexos -->
                        <div id="attachments-container">
                            <!-- Os anexos serão adicionados dinamicamente aqui -->
                        </div>

                        <!-- Botão para adicionar anexo -->
                        <button type="button" class="btn btn-outline-primary btn-sm" id="add-attachment">
                            <i class="fas fa-plus me-2"></i>Adicionar Anexo
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.order|as_crispy_field }}
                            <small class="form-text text-muted">Posição desta aula na sequência do curso.</small>
                        </div>
                        <div class="col-md-6">
                            {{ form.status|as_crispy_field }}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i> Alunos só podem ver aulas publicadas.
                            </small>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Agendamento de Liberação</label>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="id_enable_schedule"
                                name="enable_schedule">
                            <label class="form-check-label" for="id_enable_schedule">Agendar liberação</label>
                        </div>

                        <div id="schedule_fields" class="mt-3 border p-3 rounded" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="id_release_date" class="form-label">Data de liberação</label>
                                    <input type="date" class="form-control" id="id_release_date" name="release_date">
                                </div>
                                <div class="col-md-6">
                                    <label for="id_release_time" class="form-label">Hora de liberação</label>
                                    <input type="time" class="form-control" id="id_release_time" name="release_time">
                                </div>
                            </div>
                            <small class="form-text text-muted mt-2">
                                <i class="fas fa-clock me-1"></i> O conteúdo só estará disponível na data e hora
                                programadas.
                            </small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'courses:course_detail' course.id %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% if form.instance.pk %}Atualizar{% else %}Criar{% endif %}
                            Aula
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Preview Panel -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-eye me-2"></i> Pré-visualização</h5>
            </div>
            <div class="card-body">
                <div id="video-preview" class="mb-3 bg-light p-3 rounded text-center">
                    <div class="ratio ratio-16x9" id="youtube-container"
                        style="display: {% if form.instance.video_url %}block{% else %}none{% endif %};">
                        <iframe id="youtube-preview" src="" title="Preview do vídeo" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                            controlsList="nodownload" 
                            oncontextmenu="return false;"></iframe>
                    </div>
                    <div class="py-5" id="video-placeholder"
                        style="display: {% if form.instance.video_url %}none{% else %}block{% endif %};">
                        <i class="fas fa-video fa-3x mb-3 text-muted"></i>
                        <p class="text-muted">Preview do vídeo aparecerá aqui</p>
                    </div>
                </div>

                <div class="border-start border-info border-4 ps-3 mb-3">
                    <h5 id="preview-title">{{ form.instance.title|default:"Título da Aula" }}</h5>
                    <p class="small text-muted">
                        {{ form.instance.description|default:"A descrição da aula aparecerá aqui..."|truncatewords:20 }}
                    </p>
                </div>

                <div class="d-flex justify-content-between">
                    <span class="badge bg-primary">Aula {{ form.instance.order|default:"0" }}</span>
                    {% if form.instance.status == 'PUBLISHED' %}
                    <span class="badge bg-success">Publicada</span>
                    {% else %}
                    <span class="badge bg-secondary">Rascunho</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tips Panel -->
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i> Dicas</h5>
            </div>
            <div class="card-body">
                <div class="border-start border-warning ps-3 mb-3">
                    <h6><i class="fas fa-heading text-warning me-2"></i> Título Claro</h6>
                    <p class="small mb-0">Use títulos descritivos que indiquem claramente o conteúdo da aula.</p>
                </div>
                <div class="border-start border-primary ps-3 mb-3">
                    <h6><i class="fas fa-sort-numeric-down text-primary me-2"></i> Ordem Lógica</h6>
                    <p class="small mb-0">Mantenha uma sequência lógica nas aulas para facilitar o aprendizado dos
                        alunos.</p>
                </div>
                <div class="border-start border-success ps-3 mb-3">
                    <h6><i class="fas fa-video text-success me-2"></i> Vídeos de Qualidade</h6>
                    <p class="small mb-0">Certifique-se de que seus vídeos tenham boa qualidade de áudio e imagem.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    /* Allow interaction with preview iframes */
    #youtube-preview {
        pointer-events: auto; /* Enable interactions for preview */
    }

    /* Container for video preview */
    #youtube-container {
        pointer-events: auto; /* Allow container interactions */
    }
    
    /* Anti-piracy message */
    .anti-piracy-message {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 100;
        text-align: center;
        padding: 20px;
    }
    
    .anti-piracy-message h3 {
        color: #ff4444;
        margin-bottom: 10px;
    }

    /* Estilos para anexos */
    .attachment-item {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .attachment-item:hover {
        border-left-color: #0d6efd;
        background-color: #f8f9fa;
    }

    .attachment-item.bg-danger-subtle {
        background-color: #f8d7da !important;
        border-left-color: #dc3545;
    }

    .attachment-field {
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .attachment-field:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .marked-for-removal {
        animation: pulse 1s ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Melhor visualização do botão Abrir */
    .btn-group-sm .btn {
        font-size: 0.875rem;
    }

    /* Preview de tipos de arquivo */
    .attachment-type-icon {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
        display: inline-block;
    }
</style>
<script>
    // Contador de anexos para IDs únicos
    let attachmentCounter = 0;

    document.addEventListener('DOMContentLoaded', function () {
        // Gerenciamento de Anexos
        const addAttachmentBtn = document.getElementById('add-attachment');
        const attachmentsContainer = document.getElementById('attachments-container');
        const lessonForm = document.getElementById('lesson-form');

        // Array para armazenar anexos a serem removidos
        let attachmentsToRemove = [];

        // Template para novo anexo
        function createAttachmentField() {
            attachmentCounter++;
            const attachmentDiv = document.createElement('div');
            attachmentDiv.className = 'border rounded p-3 mb-3 attachment-field';
            attachmentDiv.dataset.attachmentId = `new-${attachmentCounter}`;

            attachmentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <label class="form-label">Título do Anexo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="attachment_title_${attachmentCounter}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label class="form-label">Tipo</label>
                            <select class="form-control attachment-type-select" name="attachment_type_${attachmentCounter}">
                                <option value="auto">Auto-detectar</option>
                                <option value="PDF">PDF</option>
                                <option value="AUDIO">Áudio</option>
                                <option value="IMAGE">Imagem</option>
                                <option value="DOCX">Word</option>
                                <option value="LINK">Link</option>
                                <option value="OTHER">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-new-attachment mt-4">
                            <i class="fas fa-times"></i> Remover
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-2">
                            <label class="form-label">Descrição (opcional)</label>
                            <textarea class="form-control" name="attachment_description_${attachmentCounter}" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-2">
                            <label class="form-label">Anexo</label>
                            <div class="attachment-input-group">
                                <div class="mb-2">
                                    <input type="radio" class="form-check-input attachment-choice" name="attachment_choice_${attachmentCounter}" value="file" id="file_${attachmentCounter}" checked>
                                    <label class="form-check-label me-3" for="file_${attachmentCounter}">Upload de Arquivo</label>
                                    <input type="radio" class="form-check-input attachment-choice" name="attachment_choice_${attachmentCounter}" value="link" id="link_${attachmentCounter}">
                                    <label class="form-check-label" for="link_${attachmentCounter}">Link Externo</label>
                                </div>
                                <div class="file-input-group">
                                    <input type="file" class="form-control" name="attachment_file_${attachmentCounter}" accept=".pdf,.doc,.docx,.mp3,.wav,.ogg,.m4a,.aac,.jpg,.jpeg,.png,.gif,.webp">
                                    <small class="form-text text-muted">Formatos aceitos: PDF, Word, Áudio (MP3, WAV), Imagens (JPG, PNG)</small>
                                </div>
                                <div class="link-input-group" style="display: none;">
                                    <input type="url" class="form-control" name="attachment_link_${attachmentCounter}" placeholder="https://exemplo.com/recurso">
                                    <small class="form-text text-muted">Digite a URL completa do recurso externo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return attachmentDiv;
        }

        // Adicionar novo anexo
        if (addAttachmentBtn) {
            addAttachmentBtn.addEventListener('click', function() {
                const newAttachment = createAttachmentField();
                attachmentsContainer.appendChild(newAttachment);

                // Adicionar eventos aos novos elementos
                setupAttachmentEvents(newAttachment);
            });
        }

        // Configurar eventos para um anexo
        function setupAttachmentEvents(attachmentDiv) {
            // Toggle entre arquivo e link
            const radioButtons = attachmentDiv.querySelectorAll('.attachment-choice');
            const fileGroup = attachmentDiv.querySelector('.file-input-group');
            const linkGroup = attachmentDiv.querySelector('.link-input-group');

            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'file') {
                        fileGroup.style.display = 'block';
                        linkGroup.style.display = 'none';
                        linkGroup.querySelector('input').value = '';
                    } else {
                        fileGroup.style.display = 'none';
                        linkGroup.style.display = 'block';
                        fileGroup.querySelector('input').value = '';
                    }
                });
            });

            // Remover novo anexo
            const removeBtn = attachmentDiv.querySelector('.remove-new-attachment');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    attachmentDiv.remove();
                });
            }
        }

        // Remover anexo existente
        document.querySelectorAll('.remove-attachment').forEach(btn => {
            btn.addEventListener('click', function() {
                const attachmentId = this.dataset.id;
                const attachmentItem = this.closest('.attachment-item');

                // Se já está marcado para remoção, desfaz
                if (this.classList.contains('marked-for-removal')) {
                    // Remove da lista de remoção
                    const index = attachmentsToRemove.indexOf(attachmentId);
                    if (index > -1) {
                        attachmentsToRemove.splice(index, 1);
                    }

                    // Restaura visual
                    attachmentItem.style.opacity = '1';
                    attachmentItem.style.textDecoration = 'none';
                    attachmentItem.classList.remove('bg-danger-subtle');
                    this.classList.remove('marked-for-removal', 'btn-success');
                    this.classList.add('btn-outline-danger');
                    this.innerHTML = '<i class="fas fa-trash"></i>';
                    this.title = 'Remover anexo';

                    // Remove campo hidden
                    const hiddenInput = lessonForm.querySelector(`input[name="remove_attachments"][value="${attachmentId}"]`);
                    if (hiddenInput) {
                        hiddenInput.remove();
                    }
                } else {
                    // Confirma remoção
                    const attachmentTitle = attachmentItem.querySelector('h6').textContent.trim();
                    if (confirm(`Tem certeza que deseja remover o anexo "${attachmentTitle}"?\n\nEsta ação será aplicada ao salvar as alterações.`)) {
                        // Adicionar ID à lista de anexos a remover
                        attachmentsToRemove.push(attachmentId);

                        // Adicionar visual de remoção
                        attachmentItem.style.opacity = '0.6';
                        attachmentItem.style.textDecoration = 'line-through';
                        attachmentItem.classList.add('bg-danger-subtle');
                        this.classList.add('marked-for-removal', 'btn-success');
                        this.classList.remove('btn-outline-danger');
                        this.innerHTML = '<i class="fas fa-undo"></i>';
                        this.title = 'Desfazer remoção';

                        // Adicionar campo hidden para marcar remoção
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'remove_attachments';
                        input.value = attachmentId;
                        lessonForm.appendChild(input);
                    }
                }
            });
        });

        // Modificar o submit do formulário para incluir dados de anexos
        if (lessonForm) {
            lessonForm.addEventListener('submit', function(e) {
                // Adicionar contador total de anexos
                const totalInput = document.createElement('input');
                totalInput.type = 'hidden';
                totalInput.name = 'total_new_attachments';
                totalInput.value = attachmentCounter;
                this.appendChild(totalInput);
            });
        }

        // Anti-piracy message setup
        const videoContainer = document.getElementById('video-preview');
        const youtubeContainer = document.getElementById('youtube-container');
        
        if (videoContainer) {
            // Create anti-piracy message element
            const antiPiracyMessage = document.createElement('div');
            antiPiracyMessage.className = 'anti-piracy-message';
            antiPiracyMessage.innerHTML = `
                <h3><i class="fas fa-exclamation-triangle me-2"></i>Conteúdo Protegido</h3>
                <p>Este vídeo é protegido por direitos autorais.</p>
                <p>A cópia ou distribuição não autorizada é proibida por lei.</p>
                <button class="btn btn-sm btn-light mt-3">Fechar</button>
            `;
            
            videoContainer.appendChild(antiPiracyMessage);
            
            // Right-click event for video container
            videoContainer.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                antiPiracyMessage.style.display = 'flex';
                return false;
            });
            
            // Close button handler
            const closeButton = antiPiracyMessage.querySelector('button');
            closeButton.addEventListener('click', function() {
                antiPiracyMessage.style.display = 'none';
            });
        }
        
        // Agendamento toggle
        const enableScheduleCheckbox = document.getElementById('id_enable_schedule');
        const scheduleFields = document.getElementById('schedule_fields');

        function toggleScheduleFields() {
            if (enableScheduleCheckbox.checked) {
                scheduleFields.style.display = 'block';
            } else {
                scheduleFields.style.display = 'none';
            }
        }

        enableScheduleCheckbox.addEventListener('change', toggleScheduleFields);
        toggleScheduleFields();

        // Atualização da pré-visualização (apenas se os elementos existirem)
        const titleInput = document.getElementById('id_title');
        const descriptionInput = document.getElementById('id_description');
        const previewTitle = document.getElementById('preview-title');
        const videoUrlInput = document.getElementById('id_video_url');
        const youtubePreview = document.getElementById('youtube-preview');
        const videoPlaceholder = document.getElementById('video-placeholder');

        if (titleInput && previewTitle) {
            titleInput.addEventListener('input', function () {
                previewTitle.textContent = titleInput.value || "Título da Aula";
            });
        }

        // Função para extrair o ID do YouTube de uma URL
        function extractYouTubeId(url) {
            if (!url) return null;

            // Padrão para youtube.com/watch?v=ID
            let match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\/]+)/);
            return match ? match[1] : null;
        }

        // Verifica se é um vídeo do 55JAM
        function is55JamUrl(url) {
            return url && (url.includes('play.55jam.com.br/embed') || url.includes('play.giancorrea.55jam.com.br/embed'));
        }

        // Configurar a pré-visualização do vídeo se houver URL inicial
        function setupVideoPreview() {
            if (videoUrlInput && youtubePreview) {
                const url = videoUrlInput.value;
                const youtubeId = extractYouTubeId(url);
                const is55Jam = is55JamUrl(url);

                console.log('URL:', url);
                console.log('Is 55Jam?:', is55Jam);
                console.log('YouTube ID:', youtubeId);

                if (youtubeId) {
                    youtubePreview.src = `https://www.youtube.com/embed/${youtubeId}`;
                    if (videoPlaceholder) {
                        videoPlaceholder.style.display = 'none';
                    }
                    youtubePreview.parentElement.style.display = 'block';
                } else if (is55Jam) {
                    // Para vídeos do 55JAM, usar a URL diretamente
                    console.log('Setting 55Jam URL:', url);
                    youtubePreview.src = url;
                    if (videoPlaceholder) {
                        videoPlaceholder.style.display = 'none';
                    }
                    youtubePreview.parentElement.style.display = 'block';
                } else if (url) {
                    // Se tem URL mas não é YouTube nem 55Jam reconhecido, tentar usar diretamente
                    console.log('Trying direct URL:', url);
                    youtubePreview.src = url;
                    if (videoPlaceholder) {
                        videoPlaceholder.style.display = 'none';
                    }
                    youtubePreview.parentElement.style.display = 'block';
                } else {
                    youtubePreview.src = '';
                    if (videoPlaceholder) {
                        videoPlaceholder.style.display = 'block';
                    }
                    youtubePreview.parentElement.style.display = 'none';
                }
            }
        }

        // Atualizar pré-visualização quando a URL mudar
        if (videoUrlInput) {
            videoUrlInput.addEventListener('input', setupVideoPreview);
            // Configuração inicial
            setupVideoPreview();
        }

        // Configuração inicial para URL existente
        if (youtubePreview && "{{ form.instance.video_url }}") {
            const youtubeId = extractYouTubeId("{{ form.instance.video_url }}");
            const is55Jam = is55JamUrl("{{ form.instance.video_url }}");
            
            if (youtubeId) {
                youtubePreview.src = `https://www.youtube.com/embed/${youtubeId}`;
            } else if (is55Jam) {
                youtubePreview.src = "{{ form.instance.video_url }}";
            }
        }
    });
</script>
{% endblock %}