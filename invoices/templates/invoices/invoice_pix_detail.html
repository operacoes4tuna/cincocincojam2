{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}{% translate "Pagamento Pix" %} - Nota Fiscal #{{ invoice.id }}{% endblock %}

{% block extra_css %}
<style>
    .qr-code-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
    }
    
    .pix-code-container {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .status-badge {
        font-size: 1.1em;
        padding: 10px 20px;
        border-radius: 50px;
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .invoice-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .payment-actions {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Cabeçalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">
                    <i class="fas fa-qrcode text-primary me-2"></i>
                    {% translate "Pagamento Pix" %}
                </h1>
                <a href="{% url 'invoices:invoice_detail' invoice.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    {% translate "Voltar para Nota Fiscal" %}
                </a>
            </div>

            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}

            <!-- Informações da Nota Fiscal -->
            <div class="invoice-info">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-file-invoice me-2"></i>{% translate "Nota Fiscal" %} #{{ invoice.id }}</h5>
                        <p class="mb-1"><strong>Status:</strong> {{ invoice.get_status_display }}</p>
                        <p class="mb-1"><strong>Valor:</strong> R$ {{ pix_payment.amount|floatformat:2|intcomma }}</p>
                    </div>
                    <div class="col-md-6">
                        {% if invoice.transaction %}
                            <p class="mb-1"><strong>Cliente:</strong> {{ invoice.transaction.enrollment.student.get_full_name }}</p>
                            <p class="mb-1"><strong>Curso:</strong> {{ invoice.transaction.enrollment.course.title }}</p>
                        {% elif invoice.singlesale %}
                            <p class="mb-1"><strong>Cliente:</strong> {{ invoice.singlesale.customer_name }}</p>
                            <p class="mb-1"><strong>Descrição:</strong> {{ invoice.singlesale.description }}</p>
                        {% endif %}
                        <p class="mb-0"><strong>Emitida em:</strong> {{ invoice.created_at|date:"d/m/Y H:i" }}</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Status e QR Code -->
                <div class="col-lg-8">
                    <!-- Status do Pagamento -->
                    <div id="payment-status-container" class="text-center mb-4">
                        {% if pix_payment.status == 'PAID' %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                                <h4>{% translate "Pagamento Confirmado!" %}</h4>
                                <p class="mb-0">{% translate "O pagamento foi recebido com sucesso." %}</p>
                                {% if pix_payment.paid_at %}
                                    <small class="text-muted">{{ pix_payment.paid_at|date:"d/m/Y H:i" }}</small>
                                {% endif %}
                            </div>
                        {% elif pix_payment.status == 'PENDING' %}
                            <div class="alert alert-warning" id="pending-alert">
                                <i class="fas fa-clock fa-2x mb-3 text-warning pulse"></i>
                                <h4>{% translate "Aguardando Pagamento" %}</h4>
                                <p class="mb-0">{% translate "Escaneie o QR Code abaixo ou use o código Pix para pagar." %}</p>
                                {% if pix_payment.expires_at %}
                                    <small class="text-muted">
                                        {% translate "Expira em" %}: {{ pix_payment.expires_at|date:"d/m/Y H:i" }}
                                    </small>
                                {% endif %}
                            </div>
                        {% elif pix_payment.status == 'EXPIRED' %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-hourglass-end fa-3x mb-3 text-secondary"></i>
                                <h4>{% translate "Pagamento Expirado" %}</h4>
                                <p class="mb-0">{% translate "Este pagamento Pix expirou." %}</p>
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle fa-3x mb-3 text-danger"></i>
                                <h4>{% translate "Erro no Pagamento" %}</h4>
                                <p class="mb-0">{{ pix_payment.error_message|default:"Erro desconhecido" }}</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- QR Code e Código Pix -->
                    {% if pix_payment.status == 'PENDING' %}
                        <div class="row">
                            <!-- QR Code -->
                            <div class="col-md-6 text-center">
                                <div class="qr-code-container">
                                    <h5 class="mb-3">
                                        <i class="fas fa-qrcode me-2"></i>
                                        {% translate "QR Code Pix" %}
                                    </h5>
                                    
                                    {% if qr_code_image_url %}
                                        <img src="{{ qr_code_image_url }}" 
                                             alt="QR Code Pix" 
                                             class="img-fluid" 
                                             style="max-width: 200px; border: 3px solid #dee2e6; border-radius: 10px;">
                                    {% elif qr_code_image_data %}
                                        <img src="data:image/png;base64,{{ qr_code_image_data }}" 
                                             alt="QR Code Pix" 
                                             class="img-fluid" 
                                             style="max-width: 200px; border: 3px solid #dee2e6; border-radius: 10px;">
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                                            <p>{% translate "QR Code não disponível" %}</p>
                                        </div>
                                    {% endif %}
                                    
                                    {% if pix_payment.provider_response.fallback %}
                                        <div class="alert alert-warning mt-3 small">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% translate "QR Code de demonstração" %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Código Pix Copia e Cola -->
                            <div class="col-md-6">
                                <div class="pix-code-container">
                                    <h5 class="mb-3">
                                        <i class="fas fa-copy me-2"></i>
                                        {% translate "Pix Copia e Cola" %}
                                    </h5>
                                    
                                    {% if pix_payment.brcode %}
                                        <div class="input-group mb-3">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="pixcode" 
                                                   value="{{ pix_payment.brcode }}" 
                                                   readonly 
                                                   style="font-size: 0.8em;">
                                            <button class="btn btn-primary" 
                                                    type="button" 
                                                    id="copy-button" 
                                                    onclick="copyPixCode()">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        
                                        <div id="code-copied" class="text-success small" style="display: none;">
                                            <i class="fas fa-check-circle me-1"></i>
                                            {% translate "Código copiado!" %}
                                        </div>
                                        
                                        <p class="small text-muted mt-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% translate "Copie o código acima e cole no seu aplicativo de banco para pagar via Pix." %}
                                        </p>
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <p>{% translate "Código Pix não disponível" %}</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Loading -->
                    <div id="loading-status" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{% translate "Carregando..." %}</span>
                        </div>
                        <p class="mt-2">{% translate "Verificando status do pagamento..." %}</p>
                    </div>
                </div>

                <!-- Ações Laterais -->
                <div class="col-lg-4">
                    <div class="payment-actions">
                        <h5 class="mb-3">
                            <i class="fas fa-cogs me-2"></i>
                            {% translate "Ações" %}
                        </h5>

                        <!-- Verificar Status -->
                        {% if pix_payment.status == 'PENDING' %}
                            <button id="check-status-btn" 
                                    class="btn btn-primary w-100 mb-3" 
                                    onclick="checkPaymentStatus()">
                                <i class="fas fa-sync-alt me-2"></i>
                                {% translate "Verificar Pagamento" %}
                            </button>
                        {% endif %}

                        <!-- Simulação (apenas desenvolvimento) -->
                        {% if debug and pix_payment.status == 'PENDING' %}
                            <button id="simulate-payment-btn" 
                                    class="btn btn-warning w-100 mb-3" 
                                    onclick="simulatePayment()">
                                <i class="fas fa-flask me-2"></i>
                                {% translate "Simular Pagamento" %} (Dev)
                            </button>
                        {% endif %}

                        <!-- Detalhes Técnicos -->
                        <div class="border-top pt-3 mt-3">
                            <h6 class="text-muted mb-2">{% translate "Informações Técnicas" %}</h6>
                            <ul class="list-unstyled small">
                                <li><strong>ID:</strong> {{ pix_payment.id }}</li>
                                <li><strong>Correlação:</strong> {{ pix_payment.correlation_id }}</li>
                                <li><strong>Status:</strong> {{ pix_payment.get_status_display }}</li>
                                <li><strong>Criado:</strong> {{ pix_payment.created_at|date:"d/m/Y H:i" }}</li>
                                {% if pix_payment.provider_response %}
                                    <li><strong>Provedor:</strong> 
                                        {% if pix_payment.provider_response.fallback %}
                                            Local (Simulação)
                                        {% else %}
                                            OpenPix
                                        {% endif %}
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Função para copiar o código Pix
    function copyPixCode() {
        const pixCode = document.getElementById('pixcode');
        if (pixCode) {
            pixCode.select();
            pixCode.setSelectionRange(0, 99999); // Para mobile
            document.execCommand('copy');
            
            const codeCopied = document.getElementById('code-copied');
            if (codeCopied) {
                codeCopied.style.display = 'block';
                
                // Ocultar a mensagem após 3 segundos
                setTimeout(() => {
                    codeCopied.style.display = 'none';
                }, 3000);
            }
        }
    }
    
    // Função para verificar status do pagamento
    function checkPaymentStatus() {
        const statusContainer = document.getElementById('payment-status-container');
        const loadingStatus = document.getElementById('loading-status');
        const checkBtn = document.getElementById('check-status-btn');
        
        // Mostrar loading
        if (statusContainer) statusContainer.style.display = 'none';
        if (loadingStatus) loadingStatus.style.display = 'block';
        if (checkBtn) checkBtn.disabled = true;
        
        // Fazer requisição AJAX
        fetch('{% url "invoices:check_pix_status" invoice.id %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Ocultar loading
            if (loadingStatus) loadingStatus.style.display = 'none';
            if (statusContainer) statusContainer.style.display = 'block';
            
            if (data.success) {
                if (data.status === 'PAID') {
                    // Pagamento confirmado - recarregar página
                    const pendingAlert = document.getElementById('pending-alert');
                    if (pendingAlert) {
                        pendingAlert.className = 'alert alert-success';
                        pendingAlert.innerHTML = `
                            <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                            <h4>{% translate "Pagamento Confirmado!" %}</h4>
                            <p class="mb-0">{% translate "Redirecionando..." %}</p>
                        `;
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Ainda pendente ou outro status
                    if (checkBtn) {
                        checkBtn.disabled = false;
                    }
                    
                    // Mostrar mensagem se houver
                    if (data.message) {
                        console.log('Status:', data.message);
                    }
                }
            } else {
                // Erro na verificação
                if (checkBtn) checkBtn.disabled = false;
                console.error('Erro ao verificar status:', data.error);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            if (loadingStatus) loadingStatus.style.display = 'none';
            if (statusContainer) statusContainer.style.display = 'block';
            if (checkBtn) checkBtn.disabled = false;
        });
    }
    
    // Função para simular pagamento (apenas desenvolvimento)
    function simulatePayment() {
        if (!confirm('Simular confirmação do pagamento? (Apenas para desenvolvimento)')) {
            return;
        }
        
        const simulateBtn = document.getElementById('simulate-payment-btn');
        if (simulateBtn) {
            simulateBtn.disabled = true;
            simulateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Simulando...';
        }
        
        fetch('{% url "invoices:simulate_pix_payment" invoice.id %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Pagamento simulado como confirmado!');
                window.location.reload();
            } else {
                alert('Erro ao simular pagamento: ' + (data.error || 'Erro desconhecido'));
                if (simulateBtn) {
                    simulateBtn.disabled = false;
                    simulateBtn.innerHTML = '<i class="fas fa-flask me-2"></i>{% translate "Simular Pagamento" %} (Dev)';
                }
            }
        })
        .catch(error => {
            console.error('Erro na simulação:', error);
            alert('Erro na simulação do pagamento');
            if (simulateBtn) {
                simulateBtn.disabled = false;
                simulateBtn.innerHTML = '<i class="fas fa-flask me-2"></i>{% translate "Simular Pagamento" %} (Dev)';
            }
        });
    }
    
    // Auto-verificação de status a cada 30 segundos se estiver pendente
    {% if pix_payment.status == 'PENDING' %}
    setInterval(function() {
        // Verificar automaticamente apenas se não estiver em loading
        const loadingStatus = document.getElementById('loading-status');
        if (!loadingStatus || loadingStatus.style.display === 'none') {
            checkPaymentStatus();
        }
    }, 30000); // 30 segundos
    {% endif %}
</script>
{% endblock %} 