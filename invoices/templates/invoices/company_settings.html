{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Configurações Fiscais{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para códigos de serviço */
    .service-code-form {
        transition: all 0.3s ease;
        border: 1px solid var(--bs-border-color);
    }
    
    .service-code-form:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* Tema claro */
    [data-bs-theme="light"] .service-code-form {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    
    [data-bs-theme="light"] .service-code-form:hover {
        background-color: #e9ecef;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* Tema escuro */
    [data-bs-theme="dark"] .service-code-form {
        background-color: #2b2b2b;
        border-color: #495057;
        color: #e0e0e0;
    }
    
    [data-bs-theme="dark"] .service-code-form:hover {
        background-color: #343a40;
        box-shadow: 0 0.125rem 0.25rem rgba(255, 255, 255, 0.1);
    }
    
    /* Botão de excluir */
    .btn-delete {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }
    
    .btn-delete:hover {
        background-color: #dc3545;
        color: white;
        transform: scale(1.05);
    }
    
    [data-bs-theme="dark"] .btn-delete {
        color: #ff6b6b;
    }
    
    [data-bs-theme="dark"] .btn-delete:hover {
        background-color: #ff6b6b;
        color: #212529;
    }
    
    /* Melhorias para campos de formulário no modo dark */
    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .form-select {
        background-color: #2b2b2b;
        border-color: #495057;
        color: #e0e0e0;
    }
    
    [data-bs-theme="dark"] .form-control:focus,
    [data-bs-theme="dark"] .form-select:focus {
        background-color: #2b2b2b;
        border-color: #86b7fe;
        color: #e0e0e0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    [data-bs-theme="dark"] .form-label {
        color: #e0e0e0;
    }
    
    [data-bs-theme="dark"] .form-check-label {
        color: #e0e0e0;
    }
    
    /* Alertas no modo dark */
    [data-bs-theme="dark"] .alert-info {
        background-color: #1e3a5f;
        border-color: #2c5aa0;
        color: #b8daff;
    }
    
    [data-bs-theme="dark"] .alert-warning {
        background-color: #664d03;
        border-color: #997404;
        color: #ffecb5;
    }
    
    /* Botão adicionar */
    .btn-add-service {
        transition: all 0.2s ease;
    }
    
    .btn-add-service:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
    }
    
    [data-bs-theme="dark"] .btn-add-service:hover {
        box-shadow: 0 0.25rem 0.5rem rgba(255, 255, 255, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Configurações Fiscais para Emissão de Notas</h5>
                    
                </div>
                <div class="card-body">
                    {% if not is_complete and company_config.enabled %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Para emitir notas fiscais é necessário preencher todos os campos obrigatórios.
                        </div>
                    {% endif %}
                    
                    <form method="post" id="companyForm">
                        {% csrf_token %}
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    {{ form.enabled }}
                                    <label class="form-check-label" for="{{ form.enabled.id_for_label }}">
                                        Habilitar Emissão de Nota Fiscal
                                    </label>
                                </div>
                                <small class="text-muted">
                                    Ative esta opção para habilitar a emissão de notas fiscais para seus cursos.
                                </small>
                            </div>
                        </div>
                        
                        <div id="fiscalFields" {% if not company_config.enabled %}class="d-none"{% endif %}>
                            <h5 class="border-bottom pb-2 mb-4">Dados da Empresa</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.cnpj|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.regime_tributario|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.razao_social|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.nome_fantasia|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.inscricao_municipal|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.city_service_code|as_crispy_field }}
                                </div>
                            </div>
                            
                            <h5 class="border-bottom pb-2 mb-4 mt-5">Códigos de Serviço Municipal</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                Configure aqui os códigos de serviço municipal que você utiliza. 
                                Você pode ter múltiplos códigos para diferentes tipos de serviços. 
                                <strong>Marque um como padrão</strong> para ser usado automaticamente em novas notas. Ex: 08400 (execução de música, individualmente ou por conjunto) ou 05762 (Serviços de instrução, treinamento e avaliação de conhecimentos de qualquer natureza).
                            </div>
                            
                            <div id="service-codes-section">
                                {{ formset.management_form }}
                                {% for form_item in formset %}
                                    <div class="service-code-form rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                        {% if form_item.non_field_errors %}
                                            <div class="alert alert-danger">
                                                {{ form_item.non_field_errors }}
                                            </div>
                                        {% endif %}
                                        
                                        <div class="row align-items-end">
                                            <div class="col-md-3">
                                                {{ form_item.code|as_crispy_field }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form_item.description|as_crispy_field }}
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    {{ form_item.is_default }}
                                                    <label class="form-check-label" for="{{ form_item.is_default.id_for_label }}">
                                                        <i class="fas fa-star text-warning"></i> Padrão
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                {% if formset.can_delete %}
                                                    <div class="d-none">
                                                        {{ form_item.DELETE }}
                                                    </div>
                                                    <button type="button" class="btn-delete" onclick="markForDeletion(this)" title="Excluir código de serviço">
                                                        <i class="fas fa-trash"></i> Excluir
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        {% for hidden in form_item.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="mb-4">
                                <button type="button" id="add-service-code" class="btn btn-outline-primary btn-sm btn-add-service">
                                    <i class="fas fa-plus"></i> Adicionar Código de Serviço
                                </button>
                            </div>
                            
                            <h5 class="border-bottom pb-2 mb-4 mt-5">Endereço</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    {{ form.endereco|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.numero|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.complemento|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.bairro|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.municipio|as_crispy_field }}
                                </div>
                                <div class="col-md-2">
                                    {{ form.uf|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.cep|as_crispy_field }}
                                </div>
                            </div>
                            
                            <h5 class="border-bottom pb-2 mb-4 mt-5">Contato</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    {{ form.telefone|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.email|as_crispy_field }}
                                </div>
                            </div>
                            
                            <h5 class="border-bottom pb-2 mb-4 mt-5">Configuração RPS (Recibo Provisório de Serviços)</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> O RPS (Recibo Provisório de Serviços) é um documento obrigatório para emissão de NFS-e. Configure aqui os números sequenciais de RPS que serão utilizados.
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    {{ form.rps_serie|as_crispy_field }}
                                    <small class="text-muted">Série do RPS (normalmente "1")</small>
                                </div>
                                <div class="col-md-4">
                                    {{ form.rps_numero_atual|as_crispy_field }}
                                    <small class="text-muted">Próximo número de RPS a ser emitido</small>
                                </div>
                                <div class="col-md-4">
                                    {{ form.rps_lote|as_crispy_field }}
                                    <small class="text-muted">Número do lote para envio em lote</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12 text-end">
                                <a href="{% url 'payments:professor_transactions' %}" class="btn btn-secondary">Voltar</a>
                                <button type="submit" class="btn btn-primary">Salvar Configurações</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const enabledCheckbox = document.getElementById('id_enabled');
        const fiscalFields = document.getElementById('fiscalFields');
        
        // Função para exibir/ocultar campos fiscais
        function toggleFiscalFields() {
            if (enabledCheckbox.checked) {
                fiscalFields.classList.remove('d-none');
            } else {
                fiscalFields.classList.add('d-none');
            }
        }
        
        // Evento para o checkbox
        enabledCheckbox.addEventListener('change', toggleFiscalFields);
        
        // Sincroniza o checkbox do cabeçalho com o do formulário
        const headerCheckbox = document.getElementById('enableNFe');
        headerCheckbox.addEventListener('change', function() {
            enabledCheckbox.checked = this.checked;
            toggleFiscalFields();
        });
        
        enabledCheckbox.addEventListener('change', function() {
            headerCheckbox.checked = this.checked;
        });
        
        // Funcionalidade para adicionar novos códigos de serviço
        const addButton = document.getElementById('add-service-code');
        const serviceCodesSection = document.getElementById('service-codes-section');
        
        if (addButton) {
            addButton.addEventListener('click', function() {
                const totalForms = document.getElementById('id_service_codes-TOTAL_FORMS');
                const formCount = parseInt(totalForms.value);
                
                // Verificar se existe pelo menos um formulário para clonar
                const existingForms = document.querySelectorAll('.service-code-form');
                if (existingForms.length === 0) {
                    console.error('Nenhum formulário encontrado para clonar');
                    return;
                }
                
                // Clonar o primeiro formulário como template
                const templateForm = existingForms[0].cloneNode(true);
                
                // Atualizar os IDs e nomes dos campos
                const formRegex = new RegExp('service_codes-(\\d+)-', 'g');
                templateForm.innerHTML = templateForm.innerHTML.replace(formRegex, `service_codes-${formCount}-`);
                
                // Atualizar o data-form-index
                templateForm.setAttribute('data-form-index', formCount);
                
                // Limpar os valores dos campos
                const inputs = templateForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.type !== 'hidden') {
                        input.value = '';
                    }
                });
                
                // Remover alertas de erro se existirem
                const errorAlerts = templateForm.querySelectorAll('.alert-danger');
                errorAlerts.forEach(alert => alert.remove());
                
                // Adicionar o novo formulário
                serviceCodesSection.appendChild(templateForm);
                
                // Atualizar o contador de formulários
                totalForms.value = formCount + 1;
                
                // Reconfigurar eventos para o novo formulário
                setupFormEvents();
            });
        }
        
        // Função para configurar eventos dos formulários
        function setupFormEvents() {
            // Garantir que apenas um código seja marcado como padrão
            const defaultCheckboxes = document.querySelectorAll('input[name$="-is_default"]');
            defaultCheckboxes.forEach(checkbox => {
                // Remover listeners antigos
                checkbox.removeEventListener('change', handleDefaultChange);
                // Adicionar novo listener
                checkbox.addEventListener('change', handleDefaultChange);
            });
        }
        
        // Função para lidar com mudanças no checkbox padrão
        function handleDefaultChange(event) {
            if (event.target.checked) {
                const defaultCheckboxes = document.querySelectorAll('input[name$="-is_default"]');
                defaultCheckboxes.forEach(other => {
                    if (other !== event.target) {
                        other.checked = false;
                    }
                });
            }
        }
        
        // Configurar eventos iniciais
        setupFormEvents();
    });
    
    // Função para marcar formulário para exclusão
    function markForDeletion(button) {
        const form = button.closest('.service-code-form');
        const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
        
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            
            // Adicionar efeito visual
            form.style.opacity = '0.5';
            form.style.transform = 'scale(0.95)';
            form.style.transition = 'all 0.3s ease';
            
            // Desabilitar campos
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name.indexOf('-DELETE') === -1) {
                    input.disabled = true;
                }
            });
            
            // Alterar o botão para "Desfazer"
            button.innerHTML = '<i class="fas fa-undo"></i> Desfazer';
            button.onclick = function() { undoDeletion(this); };
            button.classList.add('btn-warning');
            button.classList.remove('btn-delete');
        }
    }
    
    // Função para desfazer exclusão
    function undoDeletion(button) {
        const form = button.closest('.service-code-form');
        const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
        
        if (deleteCheckbox) {
            deleteCheckbox.checked = false;
            
            // Remover efeito visual
            form.style.opacity = '1';
            form.style.transform = 'scale(1)';
            
            // Reabilitar campos
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            
            // Restaurar o botão
            button.innerHTML = '<i class="fas fa-trash"></i> Excluir';
            button.onclick = function() { markForDeletion(this); };
            button.classList.remove('btn-warning');
            button.classList.add('btn-delete');
        }
    }
</script>
{% endblock %}
